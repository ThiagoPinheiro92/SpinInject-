<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpinInject Cloud Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --azul: #1e3a5f; --verde: #2ecc71; --amarelo: #f1c40f; --vermelho: #e74c3c; --cinza-corredor: #dfe6e9; }
        * { box-sizing: border-box; }
        body { font-family: sans-serif; background: #f0f4f8; margin: 0; padding: 5px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; height: 45px; background: white; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 16px; color: var(--azul); }
        .btn-whats { background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        .area-trabalho { display: flex; flex-direction: column; flex: 1; gap: 5px; padding-bottom: env(safe-area-inset-bottom); }

        /* --- AQUI VOCÃŠ CONTROLA A LARGURA --- */
        .layout-superior { 
            display: grid; 
            /* 1fr = Esquerda | 25px = Corredor | 1.5fr = Direita (Aumentei a direita) */
            grid-template-columns: 1fr 25px 1fr; 
            gap: 5px; 
            height: 70%; 
            /* Faz a 14 ser mais larga que as outras da mesma coluna */
             .card[data-id="32002"] {
    flex: 1.5; /* Ela cresce mais que a 12 e a 13 no sentido vertical */
    min-width: 120%; /* Ela "pula" um pouco para fora se houver espaÃ§o ou ganha peso visual */
    background-color:ffffff;
    z-index: 1;
}
            
        }

        .corredor-horizontal { height: 20px; background: var(--cinza-corredor); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #b2bec3; font-size: 9px; font-weight: bold; letter-spacing: 5px; }
        .rodape-injetoras { display: flex; gap: 5px; height: 22%; }
        .coluna { display: flex; flex-direction: column; gap: 4px; }
        .corredor-vertical { background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; writing-mode: vertical-rl; border-radius: 4px; font-weight: bold; font-size: 8px; }

        .card { background: white; border: 2px solid #ccc; border-radius: 5px; padding: 2px; flex: 1; position: relative; display: flex; flex-direction: column; justify-content: center; touch-action: none; min-height: 0; }
        .borda-F { border-color: var(--verde); }
        .borda-M { border-color: var(--amarelo); }
        .borda-D { border-color: var(--vermelho); }
        .status-OFF { background: #e0e0e0; border-color: #999 !important; opacity: 0.6; }

        .badge { position: absolute; top: 1px; left: 1px; background: #333; color: white; padding: 1px 3px; border-radius: 2px; font-size: 8px; font-weight: bold; }
        .operador { color: #0056b3; font-weight: bold; font-size: 11px; text-align: center; margin-top: 2px; line-height: 1; }
        .molde { font-size: 8px; color: #666; text-align: center; line-height: 1; }
        .obs-preview { font-size: 7px; color: #999; text-align: center; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #avatar-drag { position: fixed; pointer-events: none; display: none; z-index: 9999; font-size: 25px; }
        .hover-destino { background: #e8f4fd !important; border-style: dashed !important; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 15px; border-radius: 8px; width: 90%; max-height: 95vh; overflow-y: auto; }
        label { font-size: 12px; font-weight: bold; color: var(--azul); }
        input, select, textarea { width: 100%; margin: 4px 0 8px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn-salvar { width: 100%; padding: 12px; background: var(--azul); color: white; border: none; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1>SpinInject Cloud</h1>
        <button class="btn-whats" onclick="enviarWhats()">Enviar Escala</button>
    </header>

    <div id="loading" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10001; background:white; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2)">
        Criando nova planta...
    </div>

    <div class="area-trabalho">
        <div class="layout-superior">
            <div id="colE" class="coluna"></div>
            <div class="corredor-vertical">CORREDOR</div>
            <div id="colD" class="coluna"></div>
        </div>
        <div class="corredor-horizontal">CORREDOR</div>
        <div id="colB" class="rodape-injetoras"></div>
    </div>

    <div id="avatar-drag">ðŸ‘¤</div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <h3 id="mTit" style="margin:0 0 10px 0; font-size: 16px;">Editar</h3>
            <label>Operador:</label><input id="inOp">
            <label>Molde:</label><input id="inMol">
            <label>Dificuldade:</label>
            <select id="inDif"><option value="F">FÃ¡cil</option><option value="M">MÃ©dia</option><option value="D">DifÃ­cil</option></select>
            <label>Status:</label>
            <select id="inSt"><option value="ON">LIGADA</option><option value="OFF">OFF</option></select>
            <label>ObservaÃ§Ã£o:</label><textarea id="inObs"></textarea>
            <button class="btn-salvar" onclick="salvar()">SALVAR</button>
            <button onclick="fecharModal()" style="width:100%; margin-top:8px; border:none; color:red; background:none">Cancelar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgstf6o36yIiIL8KqR99ZF8fqHPLzUY3w",
            authDomain: "spininject.firebaseapp.com",
            databaseURL: "https://spininject-default-rtdb.firebaseio.com",
            projectId: "spininject",
            storageBucket: "spininject.firebasestorage.app",
            messagingSenderId: "213435079930",
            appId: "1:213435079930:web:79d9ff17723bbdc2a1bd43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // --- ATENÃ‡ÃƒO: MUDEI O NOME AQUI PARA 'escalaV2' PARA RESETAR OS DADOS ---
        const CAMINHO_BANCO = 'plantas/escalaV2'; 

        let maquinas = [];
        let editId = null;
        let dragId = null;
        const avatar = document.getElementById('avatar-drag');

        db.ref(CAMINHO_BANCO).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                maquinas = data;
                document.getElementById('loading').style.display = 'none';
                desenhar();
            } else {
                // Se nÃ£o existir dados na V2, ele cria com os novos nÃºmeros abaixo
                inicializarBanco();
            }
        });

        // --- EDITE OS NÃšMEROS DAS MÃQUINAS AQUI ---
        function inicializarBanco() {
            const padrao = [
                // Coluna ESQUERDA (p: 'E')
                { id: '905', p: 'E', st: 'ON', op: '', mol: '', dif: 'F', obs: '' },
                { id: '638', p: 'E', st: 'ON', op: '', mol: '', dif: 'M', obs: '' },
                { id: '639', p: 'E', st: 'ON', op: '', mol: '', dif: 'F', obs: '' },
                { id: '648', p: 'E', st: 'ON', op: '', mol: '', dif: 'D', obs: '' },
                { id: '644', p: 'E', st: 'ON', op: '', mol: '', dif: 'F', obs: '' },
                { id: '643', p: 'E', st: 'ON', op: '', mol: '', dif: 'M', obs: '' },
                { id: '408', p: 'E', st: 'ON', op: '', mol: '', dif: 'D', obs: '' },
                { id: '407', p: 'E', st: 'ON', op: '', mol: '', dif: 'M', obs: '' },

                // Coluna DIREITA (p: 'D') - Adicionei mais uma para teste
                { id: '303', p: 'D', st: 'OFF', op: '', mol: '', dif: 'F', obs: '' },
                { id: '520', p: 'D', st: 'ON', op: '', mol: '', dif: 'F', obs: '' },
                { id: '32002', p: 'D', st: 'ON', op: '', mol: '', dif: 'M', obs: '' },

                // RodapÃ© (p: 'B')
                { id: '1816', p: 'B', st: 'ON', op: '', mol: '', dif: 'F', obs: '' },
                { id: '1817', p: 'B', st: 'ON', op: '', mol: '', dif: 'M', obs: '' },
                { id: '1503', p: 'B', st: 'ON', op: '', mol: '', dif: 'D', obs: '' }
            ];
            db.ref(CAMINHO_BANCO).set(padrao);
        }

        function desenhar() {
            const elE = document.getElementById('colE');
            const elD = document.getElementById('colD');
            const elB = document.getElementById('colB');
            elE.innerHTML = elD.innerHTML = elB.innerHTML = '';

            maquinas.forEach((m) => {
                const card = document.createElement('div');
                card.className = `card borda-${m.dif} ${m.st === 'OFF' ? 'status-OFF' : ''}`;
                card.setAttribute('data-id', m.id);
                card.innerHTML = `<div class="badge">${m.id}</div><div class="operador">${m.op || '--'}</div><div class="molde">${m.mol || ''}</div><div class="obs-preview">${m.obs || ''}</div>`;
                
                card.onclick = () => { if(!dragId) abrir(m.id); };
                card.ontouchstart = (e) => { if(!m.op) return; dragId = m.id; avatar.style.display = 'block'; moverAvatar(e.touches[0]); };
                card.ontouchmove = (e) => { if(!dragId) return; moverAvatar(e.touches[0]); const alvo = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY); const cardAlvo = alvo ? alvo.closest('.card') : null; document.querySelectorAll('.card').forEach(c => c.classList.remove('hover-destino')); if(cardAlvo) cardAlvo.classList.add('hover-destino'); };
                card.ontouchend = (e) => { if(!dragId) return; avatar.style.display = 'none'; const t = e.changedTouches[0]; const el = document.elementFromPoint(t.clientX, t.clientY); const dest = el ? el.closest('.card') : null; if(dest) { const idD = dest.getAttribute('data-id'); const mO = maquinas.find(x => x.id === dragId); const mD = maquinas.find(x => x.id === idD); if(mO && mD && idD !== dragId && mD.st !== 'OFF') { mD.op = mO.op; mO.op = ''; db.ref(CAMINHO_BANCO).set(maquinas); } } dragId = null; document.querySelectorAll('.card').forEach(c => c.classList.remove('hover-destino')); };

                if (m.p === 'E') elE.appendChild(card); else if (m.p === 'D') elD.appendChild(card); else elB.appendChild(card);
            });
        }

        function moverAvatar(toque) { avatar.style.left = (toque.clientX - 12) + 'px'; avatar.style.top = (toque.clientY - 30) + 'px'; }
        
        function abrir(id) {
            editId = id;
            const m = maquinas.find(x => x.id === id);
            document.getElementById('inOp').value = m.op; document.getElementById('inMol').value = m.mol || ''; document.getElementById('inDif').value = m.dif; document.getElementById('inSt').value = m.st; document.getElementById('inObs').value = m.obs || '';
            document.getElementById('modal').style.display = 'flex';
        }

        function salvar() {
            const m = maquinas.find(x => x.id === editId);
            m.op = document.getElementById('inOp').value; m.mol = document.getElementById('inMol').value; m.dif = document.getElementById('inDif').value; m.st = document.getElementById('inSt').value; m.obs = document.getElementById('inObs').value;
            db.ref(CAMINHO_BANCO).set(maquinas);
            fecharModal();
        }

        function fecharModal() { document.getElementById('modal').style.display = 'none'; }
        function enviarWhats() { let txt = "*ESCALA SPININJECT*\n"; maquinas.forEach(m => { if(m.st === 'ON' && m.op) { txt += `ðŸ”¹ INJ-${m.id}: ${m.op} ${m.mol ? '['+m.mol+']' : ''}\n`; } }); window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(txt)); }
    </script>
</body>
</html>
