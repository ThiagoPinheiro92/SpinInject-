<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpinInject Cloud Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --azul: #1e3a5f; --verde: #2ecc71; --amarelo: #f1c40f; --vermelho: #e74c3c; --cinza-corredor: #dfe6e9; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { font-family: sans-serif; background: #f0f4f8; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding: 5px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { font-size: 16px; color: var(--azul); }
        .status-resumo { font-size: 10px; color: #666; font-weight: bold; line-height: 1.1; }
        
        .btn-top { border: none; padding: 8px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; cursor: pointer; margin-left: 3px; }
        .btn-whats { background: #25D366; }
        .btn-sheets { background: #4285F4; }

        .area-trabalho { display: flex; flex-direction: column; flex: 1; gap: 5px; }
        .layout-superior { display: grid; grid-template-columns: 1fr 25px 1fr; gap: 5px; height: 72%; position: relative; }
        .coluna { display: flex; flex-direction: column; gap: 4px; }
        #colD { justify-content: flex-end; }

        #central-equipe { position: absolute; top: 0; right: 0; width: calc(50% - 15px); height: 45%; background: #eef2f7; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; border: 2px solid #cbd5e0; z-index: 10; }
        .controles-equipe { display: flex; gap: 5px; margin-bottom: 8px; height: 35px; }
        .controles-equipe input { flex: 1; min-width: 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn-add { background: var(--azul); color: white; border: none; width: 40px; flex-shrink: 0; border-radius: 4px; font-size: 20px; }
        
        .lista-nomes { display: flex; flex-wrap: wrap; gap: 4px; overflow-y: auto; flex: 1; }
        .tag-op { background: white; border: 1px solid var(--azul); color: var(--azul); padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; user-select: none; }
        #lixeira { height: 40px; display: flex; align-items: center; justify-content: center; font-size: 24px; opacity: 0.4; border-top: 1px solid #ccc; margin-top: 5px; }

        .card { background: white; border: 2px solid #ccc; border-radius: 5px; padding: 2px; flex: 1; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .card[data-id="32002"] { flex: none !important; height: 24% !important; border-width: 3px; }
        #colD .card:not([data-id="32002"]) { flex: none; height: 11.5%; }

        .corredor-vertical { background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; writing-mode: vertical-rl; font-size: 8px; font-weight: bold; border-radius: 4px; }
        .corredor-horizontal { height: 18px; background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; font-size: 9px; font-weight: bold; letter-spacing: 5px; }
        .rodape-injetoras { display: flex; gap: 5px; height: 20%; }

        .borda-F { border-color: var(--verde); }
        .borda-M { border-color: var(--amarelo); }
        .borda-D { border-color: var(--vermelho); }
        .status-OFF { background: #e0e0e0; border-color: #999 !important; opacity: 0.6; }
        
        .badge { position: absolute; top: 1px; left: 1px; background: #333; color: white; padding: 1px 3px; border-radius: 2px; font-size: 8px; }
        .operador { color: #0056b3; font-weight: bold; font-size: 11px; width: 100%; height: 15px; }
        .molde-label { font-size: 9px; color: #333; font-weight: bold; }

        /* AVATAR ESTILIZADO */
        #avatar-drag { 
            position: fixed; 
            pointer-events: none; 
            display: none; 
            z-index: 9999; 
            background: rgba(30, 58, 95, 0.8); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: bold; 
            white-space: nowrap;
            transform: translate(-50%, -50%); /* Centraliza no dedo */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 15px; border-radius: 8px; width: 95%; max-width: 400px; }
        .btn-salvar { width: 100%; padding: 15px; background: var(--azul); color: white; border: none; border-radius: 4px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="info-header">
            <h1>SpinInject</h1>
            <div id="status-resumo" class="status-resumo">Carregando...</div>
        </div>
        <div style="display: flex;">
            <button class="btn-top btn-sheets" onclick="enviarParaSheets()">Planilha</button>
            <button class="btn-top btn-whats" onclick="enviarWhats()">WhatsApp</button>
        </div>
    </header>

    <div class="area-trabalho">
        <div class="layout-superior">
            <div id="colE" class="coluna"></div>
            <div class="corredor-vertical">CORREDOR</div>
            <div id="colD" class="coluna"></div>
            <div id="central-equipe">
                <div class="controles-equipe">
                    <input type="text" id="novo-op" placeholder="Nome Op.">
                    <button class="btn-add" onclick="addEquipe()">+</button>
                </div>
                <div id="lista-equipe" class="lista-nomes"></div>
                <div id="lixeira">üóëÔ∏è</div>
            </div>
        </div>
        <div class="corredor-horizontal">CORREDOR</div>
        <div id="colB" class="rodape-injetoras"></div>
    </div>

    <div id="avatar-drag"></div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <h3 id="modal-titulo">Editar</h3>
            <textarea id="inObs" class="inp-full" placeholder="Motivo de parada" rows="3" style="width:100%; margin-top:10px; padding:10px;"></textarea>
            <button class="btn-salvar" onclick="salvar()">SALVAR</button>
            <button onclick="fecharModal()" style="width:100%; border:none; padding:10px; color:red; background:none;">CANCELAR</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgstf6o36yIiIL8KqR99ZF8fqHPLzUY3w",
            authDomain: "spininject.firebaseapp.com",
            databaseURL: "https://spininject-default-rtdb.firebaseio.com",
            projectId: "spininject",
            storageBucket: "spininject.firebasestorage.app",
            appId: "1:213435079930:web:79d9ff17723bbdc2a1bd43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const CAMINHO = 'plantas/escalaV3';

        let maquinas = [], equipe = [], dragData = null;
        const avatar = document.getElementById('avatar-drag');

        db.ref(CAMINHO).on('value', snap => {
            const data = snap.val();
            if (data) {
                maquinas = data.maquinas || [];
                equipe = data.equipe || [];
                desenhar();
                desenharEquipe();
                atualizarResumo();
            }
        });

        // FUN√á√ÉO UNIFICADA DE DRAG
        function iniciarDrag(e, nome, origemId = null) {
            dragData = { nome: nome, origem: origemId };
            avatar.innerText = nome;
            avatar.style.display = 'block';
            moverAvatar(e.touches[0]);
        }

        function moverAvatar(touch) {
            avatar.style.left = touch.clientX + 'px';
            avatar.style.top = touch.clientY + 'px';
        }

        function finalizarDrag(e) {
            avatar.style.display = 'none';
            if (!dragData) return;

            const touch = e.changedTouches[0];
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            const cardAlvo = el?.closest('.card');
            const lixeiraAlvo = el?.closest('#lixeira');

            // Se soltou na lixeira e veio da lista
            if (lixeiraAlvo && !dragData.origem) {
                equipe = equipe.filter(n => n !== dragData.nome);
                db.ref(`${CAMINHO}/equipe`).set(equipe);
            } 
            // Se soltou em uma m√°quina
            else if (cardAlvo) {
                const idAlvo = cardAlvo.dataset.id;
                const mAlvo = maquinas.find(x => x.id === idAlvo);
                
                // Se veio de outra m√°quina, limpa a origem
                if (dragData.origem) {
                    const mOrigem = maquinas.find(x => x.id === dragData.origem);
                    if (mOrigem) mOrigem.op = '';
                }
                
                mAlvo.op = dragData.nome;
                db.ref(`${CAMINHO}/maquinas`).set(maquinas);
            }
            // Se soltou fora de tudo e veio de uma m√°quina (limpa a m√°quina)
            else if (!cardAlvo && dragData.origem) {
                const mOrigem = maquinas.find(x => x.id === dragData.origem);
                if (mOrigem) {
                    mOrigem.op = '';
                    db.ref(`${CAMINHO}/maquinas`).set(maquinas);
                }
            }

            dragData = null;
        }

        function desenharEquipe() {
            const container = document.getElementById('lista-equipe');
            container.innerHTML = '';
            equipe.forEach(nome => {
                const tag = document.createElement('div');
                tag.className = 'tag-op';
                tag.innerText = nome;
                tag.addEventListener('touchstart', (e) => iniciarDrag(e, nome), {passive: false});
                tag.addEventListener('touchmove', (e) => { e.preventDefault(); moverAvatar(e.touches[0]); }, {passive: false});
                tag.addEventListener('touchend', finalizarDrag);
                container.appendChild(tag);
            });
        }

        function desenhar() {
            const cols = { E: document.getElementById('colE'), D: document.getElementById('colD'), B: document.getElementById('colB') };
            Object.values(cols).forEach(c => c.innerHTML = '');
            
            maquinas.forEach(m => {
                const card = document.createElement('div');
                card.className = `card borda-${m.dif} ${m.st==='OFF'?'status-OFF':''}`;
                card.setAttribute('data-id', m.id);
                card.innerHTML = `
                    <div class="badge">${m.id}</div>
                    <div class="operador" id="op-${m.id}">${m.op||''}</div>
                    <div class="molde-label">${m.mol||''}</div>
                `;

                // Clique para abrir modal
                card.onclick = (e) => { if(!dragData) abrir(m.id); };

                // DRAG PARA MOVER OPERADOR DA M√ÅQUINA
                const areaOp = card.querySelector('.operador');
                areaOp.addEventListener('touchstart', (e) => {
                    if(m.op) {
                        e.stopPropagation();
                        iniciarDrag(e, m.op, m.id);
                    }
                }, {passive: false});
                
                areaOp.addEventListener('touchmove', (e) => {
                    if(dragData) { e.preventDefault(); moverAvatar(e.touches[0]); }
                }, {passive: false});

                areaOp.addEventListener('touchend', finalizarDrag);

                cols[m.p].appendChild(card);
            });
        }

        function atualizarResumo() {
            const ligadas = maquinas.filter(m => m.st === 'ON').length;
            const ops = new Set(maquinas.filter(m => m.op && m.st==='ON').map(m => m.op)).size;
            const moinho = maquinas.some(m => (m.id==='32002' && m.st==='ON'));
            document.getElementById('status-resumo').innerHTML = `
                ${ligadas} Maq. ON | ${ops} Operadores<br>
                ${moinho ? '<span class="destaque-moinho">+ 1 MOINHO ATIVO</span>' : 'Moinho OFF'}
            `;
        }

        function addEquipe() {
            const n = document.getElementById('novo-op').value.trim();
            if(n) { equipe.push(n); db.ref(`${CAMINHO}/equipe`).set(equipe); document.getElementById('novo-op').value=''; }
        }

        let editId = null;
        function abrir(id) {
            editId = id; const m = maquinas.find(x=>x.id===id);
            document.getElementById('modal-titulo').innerText = `INJETORA ${m.id}`;
            document.getElementById('inObs').value = m.obs || "";
            document.getElementById('modal').style.display = 'flex';
        }

        function salvar() {
            const m = maquinas.find(x=>x.id===editId);
            m.obs = document.getElementById('inObs').value;
            db.ref(`${CAMINHO}/maquinas`).set(maquinas);
            fecharModal();
        }

        function fecharModal() { document.getElementById('modal').style.display = 'none'; }

        function enviarParaSheets() { alert("URL do Sheets n√£o configurada."); }

        function enviarWhats() {
            let t = "*ESCALA SPININJECT*\n";
            maquinas.forEach(m => { if(m.st==='ON' && m.op) t += `üîπ ${m.id}: ${m.op} [${m.mol}]\n`; });
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(t));
        }
    </script>
</body>
</html>
