<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpinInject Cloud Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        /* Cores principais do sistema */
        :root { --azul: #1e3a5f; --verde: #2ecc71; --amarelo: #f1c40f; --vermelho: #e74c3c; --cinza-corredor: #dfe6e9; }
        
        /* Reset b√°sico e travas de toque para celular */
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { font-family: sans-serif; background: #f0f4f8; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding: 5px; }
        
        /* Cabe√ßalho */
        header { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { font-size: 16px; color: var(--azul); }
        .status-resumo { font-size: 10px; color: #666; font-weight: bold; line-height: 1.1; }
        .destaque-moinho { color: #e67e22; font-weight: 900; }
        
        /* Bot√µes do topo */
        .btn-top { border: none; padding: 8px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; cursor: pointer; margin-left: 3px; }
        .btn-whats { background: #25D366; }
        .btn-sheets { background: #4285F4; }

        /* Estrutura do Layout (Injetoras e Equipe) */
        .area-trabalho { display: flex; flex-direction: column; flex: 1; gap: 5px; }
        .layout-superior { display: grid; grid-template-columns: 1fr 25px 1fr; gap: 5px; height: 72%; position: relative; }
        .coluna { display: flex; flex-direction: column; gap: 4px; }
        #colD { justify-content: flex-end; }

        /* Caixa azul da equipe */
        #central-equipe { position: absolute; top: 0; right: 0; width: calc(50% - 15px); height: 45%; background: #eef2f7; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; border: 2px solid #cbd5e0; z-index: 10; }
        .controles-equipe { display: flex; gap: 5px; margin-bottom: 8px; height: 35px; width: 100%; }
        .controles-equipe input { flex: 1; min-width: 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn-add { background: var(--azul); color: white; border: none; width: 40px; flex-shrink: 0; border-radius: 4px; font-size: 20px; font-weight: bold; }
        
        /* Nomes dos operadores (Tags) */
        .lista-nomes { display: flex; flex-wrap: wrap; gap: 4px; overflow-y: auto; flex: 1; }
        .tag-op { background: white; border: 1px solid var(--azul); color: var(--azul); padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; user-select: none; }
        #lixeira { height: 40px; display: flex; align-items: center; justify-content: center; font-size: 24px; opacity: 0.4; border-top: 1px solid #ccc; margin-top: 5px; }

        /* Estilo dos Cards das M√°quinas */
        .card { background: white; border: 2px solid #ccc; border-radius: 5px; padding: 2px; flex: 1; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .card[data-id="32002"] { flex: none !important; height: 24% !important; border-width: 3px; }
        #colD .card:not([data-id="32002"]) { flex: none; height: 11.5%; }

        /* Corredores cinzas */
        .corredor-vertical { background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; writing-mode: vertical-rl; font-size: 8px; font-weight: bold; border-radius: 4px; }
        .corredor-horizontal { height: 18px; background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; font-size: 9px; font-weight: bold; letter-spacing: 5px; }
        .rodape-injetoras { display: flex; gap: 5px; height: 20%; }

        /* Cores de dificuldade e bordas */
        .borda-F { border-color: var(--verde); }
        .borda-M { border-color: var(--amarelo); }
        .borda-D { border-color: var(--vermelho); }
        .status-OFF { background: #e0e0e0; border-color: #999 !important; opacity: 0.6; }
        
        .badge { position: absolute; top: 1px; left: 1px; background: #333; color: white; padding: 1px 3px; border-radius: 2px; font-size: 8px; }
        .operador { color: #0056b3; font-weight: bold; font-size: 11px; min-height: 15px; width: 100%; }
        .molde-label { font-size: 9px; color: #333; font-weight: bold; }

        /* Avatar que segue o dedo no arraste */
        #avatar-drag { position: fixed; pointer-events: none; display: none; z-index: 9999; background: rgba(30, 58, 95, 0.9); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; transform: translate(-50%, -50%); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }

        /* Janela Modal de Edi√ß√£o */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 15px; border-radius: 8px; width: 95%; max-width: 400px; max-height: 95vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* Chave ON/OFF */
        .switch { position: relative; width: 50px; height: 24px; }
        .switch input { opacity: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--verde); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .inp-full { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-size: 14px; }
        .area-moldes { background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .lista-moldes { max-height: 150px; overflow-y: auto; margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .item-molde { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .molde-ativo { border: 2.5px solid var(--azul) !important; background: #e8f4fd; font-weight: bold; }
        .bola-dif { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .bg-F { background: var(--verde); } .bg-M { background: var(--amarelo); } .bg-D { background: var(--vermelho); }
        .btn-salvar { width: 100%; padding: 15px; background: var(--azul); color: white; border: none; border-radius: 4px; font-weight: bold; margin-top: 10px; font-size: 16px; }
    </style>
</head>
<body>

    <header>
        <div class="info-header">
            <h1>Status Inje√ß√£o</h1>
            <div id="status-resumo" class="status-resumo">Carregando...</div>
        </div>
        <div style="display: flex;">
            <button class="btn-top btn-sheets" onclick="enviarParaSheets()">Planilha</button>
            <button class="btn-top btn-whats" onclick="enviarWhats()">WhatsApp</button>
        </div>
    </header>

    <div class="area-trabalho">
        <div class="layout-superior">
            <div id="colE" class="coluna"></div>
            <div class="corredor-vertical">CORREDOR</div>
            <div id="colD" class="coluna"></div>
            <div id="central-equipe">
                <div class="controles-equipe">
                    <input type="text" id="novo-op" placeholder="Add Op.">
                    <button class="btn-add" onclick="addEquipe()">+</button>
                </div>
                <div id="lista-equipe" class="lista-nomes"></div>
                <div id="lixeira">üóëÔ∏è</div>
            </div>
        </div>
        <div class="corredor-horizontal">CORREDOR</div>
        <div id="colB" class="rodape-injetoras"></div>
    </div>

    <div id="avatar-drag"></div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-titulo">Editar</h3>
                <label class="switch"><input type="checkbox" id="switchSt"><span class="slider"></span></label>
            </div>
            <label style="font-size:11px; font-weight:bold; color:var(--azul)">OPERADOR:</label>
            <input id="inOp" class="inp-full">
            <label style="font-size:11px; font-weight:bold; color:var(--azul)">MOLDE SELECIONADO:</label>
            <input id="inMolDisplay" class="inp-full" readonly style="background:#f0f0f0;">
            <div class="area-moldes">
                <div style="display:flex; gap:5px; margin-bottom:5px">
                    <input id="newMolCod" placeholder="C√≥d." style="flex:1; padding:8px;">
                    <select id="newMolDif"><option value="F">Verde</option><option value="M">Amarelo</option><option value="D">Vermelho</option></select>
                </div>
                <div style="display:flex; gap:5px">
                    <input id="newMolNome" placeholder="Nome do Molde" style="flex:2; padding:8px;">
                    <button onclick="addMolde()" style="background:var(--azul); color:white; border:none; padding:0 15px; border-radius:4px">ADD</button>
                </div>
                <div id="lista-moldes-maquina" class="lista-moldes"></div>
            </div>
            <textarea id="inObs" class="inp-full" placeholder="Motivo de parada / Observa√ß√µes" rows="2" style="margin-top:10px"></textarea>
            <button class="btn-salvar" onclick="salvar()">SALVAR</button>
            <button onclick="fecharModal()" style="width:100%; border:none; padding:10px; color:red; background:none;">CANCELAR</button>
        </div>
    </div>

    <script>
        // Conex√£o com o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAgstf6o36yIiIL8KqR99ZF8fqHPLzUY3w",
            authDomain: "spininject.firebaseapp.com",
            databaseURL: "https://spininject-default-rtdb.firebaseio.com",
            projectId: "spininject",
            storageBucket: "spininject.firebasestorage.app",
            appId: "1:213435079930:web:79d9ff17723bbdc2a1bd43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const CAMINHO = 'plantas/escalaV3';

        let maquinas = [], equipe = [], dragData = null, editId = null, tempDif = 'F';
        const avatar = document.getElementById('avatar-drag');

        // Escuta o banco de dados e atualiza a interface
        db.ref(CAMINHO).on('value', snap => {
            const data = snap.val();
            if (data) {
                maquinas = data.maquinas || [];
                equipe = data.equipe || [];
                desenhar();
                desenharEquipe();
                atualizarResumo();
            }
        });

        // Calcula os n√∫meros do topo e verifica o Moinho
        function atualizarResumo() {
            const ligadas = maquinas.filter(m => m.st === 'ON').length;
            const ops = new Set(
                maquinas.filter(m => m.op && m.st==='ON' && m.op.toUpperCase() !== 'MOINHO').map(m => m.op)
            ).size;
            
            // Regra: se o operador "Moinho" estiver em alguma m√°quina, exibe o aviso
            const moinhoAtribuido = maquinas.some(m => m.op && m.op.toUpperCase() === 'MOINHO');

            document.getElementById('status-resumo').innerHTML = `
                ${ligadas} M√°quinas ON | ${ops} Operadores<br>
                ${moinhoAtribuido ? '<span class="destaque-moinho">+ 1 MOINHO ATIVO</span>' : '<span style="color:#999">Moinho OFF</span>'}
            `;
        }

        // Fun√ß√µes de Arrastar (Drag and Drop)
        function iniciarDrag(e, nome, origemId = null) {
            dragData = { nome, origem: origemId };
            avatar.innerText = nome;
            avatar.style.display = 'block';
            moverAvatar(e.touches[0]);
        }
        function moverAvatar(t) { 
            avatar.style.left = t.clientX + 'px'; 
            avatar.style.top = t.clientY + 'px'; 
        }
        function finalizarDrag(e) {
            avatar.style.display = 'none'; 
            if (!dragData) return;
            
            const t = e.changedTouches[0];
            const el = document.elementFromPoint(t.clientX, t.clientY);
            const card = el?.closest('.card'), lixeira = el?.closest('#lixeira');

            if (lixeira && !dragData.origem) {
                equipe = equipe.filter(n => n !== dragData.nome);
                db.ref(`${CAMINHO}/equipe`).set(equipe);
            } else if (card) {
                if (dragData.origem) {
                    const mO = maquinas.find(x => x.id === dragData.origem);
                    if (mO) mO.op = '';
                }
                const mA = maquinas.find(x => x.id === card.dataset.id);
                mA.op = dragData.nome;
                db.ref(`${CAMINHO}/maquinas`).set(maquinas);
            } else if (!card && dragData.origem) {
                const mO = maquinas.find(x => x.id === dragData.origem);
                if (mO) { mO.op = ''; db.ref(`${CAMINHO}/maquinas`).set(maquinas); }
            }
            dragData = null;
        }

        // Gera os cards das m√°quinas na tela
        function desenhar() {
            const cols = { E: document.getElementById('colE'), D: document.getElementById('colD'), B: document.getElementById('colB') };
            Object.values(cols).forEach(c => c.innerHTML = '');
            maquinas.forEach(m => {
                const card = document.createElement('div');
                card.className = `card borda-${m.dif} ${m.st==='OFF'?'status-OFF':''}`;
                card.setAttribute('data-id', m.id);
                card.innerHTML = `<div class="badge">${m.id}</div><div class="operador">${m.op||''}</div><div class="molde-label">${m.mol||''}</div>`;
                
                card.onclick = (e) => { if(!dragData) abrir(m.id); };
                
                const opArea = card.querySelector('.operador');
                opArea.addEventListener('touchstart', (e) => { if(m.op){ e.stopPropagation(); iniciarDrag(e, m.op, m.id); } }, {passive:false});
                opArea.addEventListener('touchmove', (e) => { if(dragData){ e.preventDefault(); moverAvatar(e.touches[0]); } }, {passive:false});
                opArea.addEventListener('touchend', finalizarDrag);
                
                cols[m.p].appendChild(card);
            });
        }

        // Gera a lista de operadores (caixa azul)
        function desenharEquipe() {
            const container = document.getElementById('lista-equipe'); container.innerHTML = '';
            equipe.forEach(n => {
                const tag = document.createElement('div'); tag.className = 'tag-op'; tag.innerText = n;
                tag.addEventListener('touchstart', (e) => iniciarDrag(e, n), {passive:false});
                tag.addEventListener('touchmove', (e) => { e.preventDefault(); moverAvatar(e.touches[0]); }, {passive:false});
                tag.addEventListener('touchend', finalizarDrag);
                container.appendChild(tag);
            });
        }

        // Fun√ß√µes do Modal de Edi√ß√£o
        function abrir(id) {
            editId = id; const m = maquinas.find(x=>x.id===id);
            document.getElementById('modal-titulo').innerText = `EDITAR INJ-${m.id}`;
            document.getElementById('switchSt').checked = m.st==='ON';
            document.getElementById('inOp').value = m.op;
            document.getElementById('inMolDisplay').value = m.mol;
            document.getElementById('inObs').value = m.obs || "";
            tempDif = m.dif; renderMoldes();
            document.getElementById('modal').style.display = 'flex';
        }

        function renderMoldes() {
            const m = maquinas.find(x=>x.id===editId);
            const l = document.getElementById('lista-moldes-maquina'); l.innerHTML = '';
            (m.moldes||[]).forEach((mo, i) => {
                const item = document.createElement('div');
                const txt = `${mo.cod} - ${mo.nome}`;
                item.className = `item-molde ${document.getElementById('inMolDisplay').value===txt?'molde-ativo':''}`;
                item.innerHTML = `<div><span class="bola-dif bg-${mo.dif}"></span>${txt}</div><b onclick="event.stopPropagation(); delMolde(${i})">‚úï</b>`;
                item.onclick = () => { document.getElementById('inMolDisplay').value = txt; tempDif = mo.dif; renderMoldes(); };
                l.appendChild(item);
            });
        }

        function addMolde() {
            const c = document.getElementById('newMolCod').value, n = document.getElementById('newMolNome').value, d = document.getElementById('newMolDif').value;
            if(c && n) {
                const m = maquinas.find(x=>x.id===editId); if(!m.moldes) m.moldes = [];
                m.moldes.push({cod:c, nome:n, dif:d});
                db.ref(`${CAMINHO}/maquinas`).set(maquinas); renderMoldes();
            }
        }

        function delMolde(i) {
            const m = maquinas.find(x=>x.id===editId); m.moldes.splice(i, 1);
            db.ref(`${CAMINHO}/maquinas`).set(maquinas); renderMoldes();
        }

        function salvar() {
            const m = maquinas.find(x=>x.id===editId);
            m.op = document.getElementById('inOp').value;
            m.st = document.getElementById('switchSt').checked ? 'ON' : 'OFF';
            m.mol = document.getElementById('inMolDisplay').value;
            m.obs = document.getElementById('inObs').value;
            m.dif = tempDif;
            db.ref(`${CAMINHO}/maquinas`).set(maquinas); fecharModal();
        }

        function fecharModal() { document.getElementById('modal').style.display = 'none'; }

        function addEquipe() {
            const n = document.getElementById('novo-op').value.trim();
            if(n) { equipe.push(n); db.ref(`${CAMINHO}/equipe`).set(equipe); document.getElementById('novo-op').value=''; }
        }

        function enviarWhats() {
            let t = "*ESCALA Inje√ß√£o*\n";
            maquinas.forEach(m => { if(m.st==='ON' && m.op) t += `üîπ ${m.id}: ${m.op} [${m.mol}]\n`; });
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(t));
        }

        // Envia os dados para a Planilha do Google
        function enviarParaSheets() {
            const url = "https://script.google.com/macros/s/AKfycbxEKq4ZmkNT_5MOzUBUS9rQmiVqv22Si19YJPXKLsPh3mk-Lp40dDYdW6IvRSfQ8oCO5w/exec"; 

            fetch(url, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(maquinas) 
            })
            .then(() => alert("Dados enviados para a planilha!"))
            .catch(e => alert("Erro ao enviar: " + e));
        }
    </script>
</body>
</html>
