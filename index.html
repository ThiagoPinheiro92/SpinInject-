<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpinInject Cloud Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --azul: #1e3a5f; --verde: #2ecc71; --amarelo: #f1c40f; --vermelho: #e74c3c; --cinza-corredor: #dfe6e9; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: #f0f4f8; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding: 5px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { font-size: 16px; color: var(--azul); }
        .status-resumo { font-size: 11px; color: #666; font-weight: bold; }
        .btn-whats { background: #25D366; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        .area-trabalho { display: flex; flex-direction: column; flex: 1; gap: 5px; }
        .layout-superior { display: grid; grid-template-columns: 1fr 25px 1fr; gap: 5px; height: 72%; position: relative; }
        .coluna { display: flex; flex-direction: column; gap: 4px; }
        #colD { justify-content: flex-end; }

        #central-equipe { position: absolute; top: 0; right: 0; width: calc(50% - 15px); height: 45%; background: #eef2f7; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; border: 2px solid #cbd5e0; z-index: 10; }
        .controles-equipe { display: flex; gap: 5px; margin-bottom: 8px; height: 35px; }
        .controles-equipe input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn-add { background: var(--azul); color: white; border: none; width: 40px; border-radius: 4px; font-size: 20px; }
        .lista-nomes { display: flex; flex-wrap: wrap; gap: 4px; overflow-y: auto; }
        .tag-op { background: white; border: 1px solid var(--azul); color: var(--azul); padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
        #lixeira { height: 35px; display: flex; align-items: center; justify-content: center; font-size: 20px; opacity: 0.5; border-top: 1px solid #ccc; }
        .lixeira-ativa { background: #ff7675 !important; opacity: 1 !important; }

        .card { background: white; border: 2px solid #ccc; border-radius: 5px; padding: 2px; flex: 1; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .card[data-id="32002"] { flex: none !important; height: 24% !important; border-width: 3px; }
        #colD .card:not([data-id="32002"]) { flex: none; height: 11.5%; }

        .corredor-vertical { background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; writing-mode: vertical-rl; font-size: 8px; font-weight: bold; border-radius: 4px; }
        .corredor-horizontal { height: 18px; background: var(--cinza-corredor); display: flex; align-items: center; justify-content: center; color: #b2bec3; font-size: 9px; font-weight: bold; letter-spacing: 5px; }
        .rodape-injetoras { display: flex; gap: 5px; height: 20%; }

        .borda-F { border-color: var(--verde); }
        .borda-M { border-color: var(--amarelo); }
        .borda-D { border-color: var(--vermelho); }
        .status-OFF { background: #e0e0e0; border-color: #999 !important; opacity: 0.6; }
        
        .badge { position: absolute; top: 1px; left: 1px; background: #333; color: white; padding: 1px 3px; border-radius: 2px; font-size: 8px; }
        .operador { color: #0056b3; font-weight: bold; font-size: 11px; }
        .molde-label { font-size: 9px; color: #333; font-weight: 500; }

        #avatar-drag { position: fixed; pointer-events: none; display: none; z-index: 9999; font-size: 24px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 15px; border-radius: 8px; width: 95%; max-width: 400px; max-height: 95vh; overflow-y: auto; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .switch { position: relative; width: 50px; height: 24px; }
        .switch input { opacity: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 34px; transition: .4s; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--verde); }
        input:checked + .slider:before { transform: translateX(26px); }

        .inp-full { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-size: 14px; }
        .area-moldes { background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .form-molde-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .lista-moldes { max-height: 120px; overflow-y: auto; margin-top: 10px; display: flex; flex-direction: column; gap: 4px; }
        .item-molde { display: flex; justify-content: space-between; background: white; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .molde-ativo { border: 2px solid var(--azul); background: #e8f4fd; }
        .bola-dif { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .btn-salvar { width: 100%; padding: 15px; background: var(--azul); color: white; border: none; border-radius: 4px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="info-header">
            <h1>SpinInject Cloud</h1>
            <div id="status-resumo" class="status-resumo">Carregando...</div>
        </div>
        <button class="btn-whats" onclick="enviarWhats()">Enviar Escala</button>
    </header>

    <div class="area-trabalho">
        <div class="layout-superior">
            <div id="colE" class="coluna"></div>
            <div class="corredor-vertical">CORREDOR</div>
            <div id="colD" class="coluna"></div>
            <div id="central-equipe">
                <div class="controles-equipe"><input type="text" id="novo-op" placeholder="Add Op."><button class="btn-add" onclick="addEquipe()">+</button></div>
                <div id="lista-equipe" class="lista-nomes"></div>
                <div id="lixeira">üóëÔ∏è</div>
            </div>
        </div>
        <div class="corredor-horizontal">CORREDOR</div>
        <div id="colB" class="rodape-injetoras"></div>
    </div>

    <div id="avatar-drag">üë§</div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-titulo">Editar</h3>
                <label class="switch"><input type="checkbox" id="switchSt"><span class="slider"></span></label>
            </div>
            <input id="inOp" class="inp-full" placeholder="Operador">
            <input id="inMolDisplay" class="inp-full" readonly placeholder="Selecione o molde abaixo" style="background:#eee">
            <div class="area-moldes">
                <div class="form-molde-row">
                    <input id="newMolCod" placeholder="C√≥d. Molde" style="flex:2; padding:8px;">
                    <select id="newMolDif" style="flex:1;"><option value="F">Verde</option><option value="M">Amarelo</option><option value="D">Vermelho</option></select>
                </div>
                <div class="form-molde-row">
                    <input id="newMolNome" placeholder="Nome do Molde" style="flex:3; padding:8px;">
                    <button onclick="addMolde()" style="flex:1; background:var(--azul); color:white; border:none; border-radius:4px;">+</button>
                </div>
                <div id="lista-moldes-maquina" class="lista-moldes"></div>
            </div>
            <textarea id="inObs" class="inp-full" placeholder="Observa√ß√£o" rows="2" style="margin-top:10px"></textarea>
            <button class="btn-salvar" onclick="salvar()">SALVAR</button>
            <button onclick="fecharModal()" style="width:100%; padding:10px; background:none; border:none; color:red;">Cancelar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgstf6o36yIiIL8KqR99ZF8fqHPLzUY3w",
            authDomain: "spininject.firebaseapp.com",
            databaseURL: "https://spininject-default-rtdb.firebaseio.com",
            projectId: "spininject",
            storageBucket: "spininject.firebasestorage.app",
            appId: "1:213435079930:web:79d9ff17723bbdc2a1bd43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const CAMINHO = 'plantas/escalaV3';

        let maquinas = [], equipe = [], dragInfo = null, editId = null, tempDif = 'F';
        const avatar = document.getElementById('avatar-drag');

        db.ref(CAMINHO).on('value', snap => {
            const data = snap.val();
            if (data && data.maquinas) {
                maquinas = data.maquinas;
                equipe = data.equipe || [];
                desenhar();
                desenharEquipe();
            } else { inicializarBanco(); }
        });

        function inicializarBanco() {
            const mIds = ['905','638','639','648','644','643','408','407','303','520','32002','1816','1817','1503'];
            const padrao = {
                maquinas: mIds.map(id => ({ id, p: id==='303'||id==='520'||id==='32002'?'D':(id==='1816'||id==='1817'||id==='1503'?'B':'E'), st:'ON', op:'', mol:'', dif:'F', obs:'', moldes:[] })),
                equipe: []
            };
            db.ref(CAMINHO).set(padrao);
        }

        function addEquipe() {
            const n = document.getElementById('novo-op').value.trim();
            if(n) { equipe.push(n); db.ref(`${CAMINHO}/equipe`).set(equipe); document.getElementById('novo-op').value=''; }
        }

        function desenharEquipe() {
            const c = document.getElementById('lista-equipe'); c.innerHTML = '';
            equipe.forEach(n => {
                const t = document.createElement('div'); t.className = 'tag-op'; t.innerText = n;
                t.ontouchstart = (e) => { dragInfo = { tipo:'equipe', valor:n }; avatar.style.display='block'; moverAvatar(e.touches[0]); };
                t.ontouchmove = (e) => moverAvatar(e.touches[0]);
                t.ontouchend = (e) => finalizarDrag(e.changedTouches[0]);
                c.appendChild(t);
            });
        }

        function desenhar() {
            const cols = { E: document.getElementById('colE'), D: document.getElementById('colD'), B: document.getElementById('colB') };
            Object.values(cols).forEach(c => c.innerHTML = '');
            maquinas.forEach(m => {
                const card = document.createElement('div');
                card.className = `card borda-${m.dif} ${m.st==='OFF'?'status-OFF':''}`;
                card.setAttribute('data-id', m.id);
                card.innerHTML = `<div class="badge">${m.id}</div><div class="operador">${m.op||'--'}</div><div class="molde-label">${m.mol||''}</div>`;
                card.onclick = () => abrir(m.id);
                cols[m.p].appendChild(card);
            });
            const lig = maquinas.filter(m=>m.st==='ON').length;
            document.getElementById('status-resumo').innerText = `${lig} M√°quinas Ativas`;
        }

        function moverAvatar(t) { avatar.style.left = (t.clientX - 10)+'px'; avatar.style.top = (t.clientY - 20)+'px'; }

        function finalizarDrag(t) {
            avatar.style.display = 'none';
            const el = document.elementFromPoint(t.clientX, t.clientY);
            const dCard = el?.closest('.card');
            const dLixeira = el?.closest('#lixeira');
            if(dragInfo?.tipo==='equipe') {
                if(dLixeira) { equipe = equipe.filter(n=>n!==dragInfo.valor); db.ref(`${CAMINHO}/equipe`).set(equipe); }
                else if(dCard) { const m = maquinas.find(x=>x.id===dCard.dataset.id); if(m) { m.op = dragInfo.valor; db.ref(`${CAMINHO}/maquinas`).set(maquinas); } }
            }
            dragInfo = null;
        }

        function abrir(id) {
            editId = id; const m = maquinas.find(x=>x.id===id);
            document.getElementById('modal-titulo').innerText = `Injetora ${m.id}`;
            document.getElementById('switchSt').checked = m.st==='ON';
            document.getElementById('inOp').value = m.op;
            document.getElementById('inMolDisplay').value = m.mol;
            document.getElementById('inObs').value = m.obs;
            tempDif = m.dif; renderMoldes(m);
            document.getElementById('modal').style.display = 'flex';
        }

        function renderMoldes(m) {
            const l = document.getElementById('lista-moldes-maquina'); l.innerHTML = '';
            (m.moldes||[]).forEach((mo, i) => {
                const item = document.createElement('div'); item.className = `item-molde ${m.mol===mo.cod+' - '+mo.nome?'molde-ativo':''}`;
                item.innerHTML = `<div><span class="bola-dif bg-${mo.dif}"></span>${mo.cod} - ${mo.nome}</div><b onclick="delMolde(${i})">‚úï</b>`;
                item.onclick = (e) => { if(e.target.tagName!=='B') { document.getElementById('inMolDisplay').value = `${mo.cod} - ${mo.nome}`; tempDif = mo.dif; renderMoldes(m); } };
                l.appendChild(item);
            });
        }

        function addMolde() {
            const c = document.getElementById('newMolCod').value, n = document.getElementById('newMolNome').value, d = document.getElementById('newMolDif').value;
            if(c && n) {
                const m = maquinas.find(x=>x.id===editId); if(!m.moldes) m.moldes = [];
                m.moldes.push({cod:c, nome:n, dif:d});
                document.getElementById('newMolCod').value=''; document.getElementById('newMolNome').value='';
                db.ref(`${CAMINHO}/maquinas`).set(maquinas); renderMoldes(m);
            }
        }

        function delMolde(i) {
            const m = maquinas.find(x=>x.id===editId); m.moldes.splice(i, 1);
            db.ref(`${CAMINHO}/maquinas`).set(maquinas); renderMoldes(m);
        }

        function salvar() {
            const m = maquinas.find(x=>x.id===editId);
            m.op = document.getElementById('inOp').value;
            m.st = document.getElementById('switchSt').checked ? 'ON' : 'OFF';
            m.mol = document.getElementById('inMolDisplay').value;
            m.obs = document.getElementById('inObs').value;
            m.dif = tempDif;
            db.ref(`${CAMINHO}/maquinas`).set(maquinas); fecharModal();
        }

        function fecharModal() { document.getElementById('modal').style.display = 'none'; }

        function enviarWhats() {
            let t = "*ESCALA SPININJECT*\n";
            maquinas.forEach(m => { if(m.st==='ON' && m.op) t += `üîπ INJ-${m.id}: ${m.op} [${m.mol}]\n`; });
            window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(t));
        }
    </script>
</body>
</html>
